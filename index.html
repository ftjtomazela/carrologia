<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cessna Mobile Flight</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; touch-action: none; }
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* HUD AVIÃO */
        #plane-hud {
            position: absolute; bottom: 15%; left: 50%; 
            width: 400px; height: 300px; transform: translateX(-50%);
            z-index: 10; pointer-events: none;
            display: flex; justify-content: center; align-items: flex-end;
        }
        /* Ajuste para celular */
        @media (max-width: 600px) {
            #plane-hud { width: 300px; height: 200px; bottom: 20%; }
        }

        #plane-img { width: 100%; will-change: transform; }
        
        #prop-blur {
            position: absolute; bottom: 35%; left: 50%; width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            transform: translateX(-50%); border-radius: 50%; display: none;
        }

        /* CONTROLE MOBILE - SLIDER DE ACELERAÇÃO */
        #mobile-controls {
            position: absolute; left: 20px; bottom: 50px; height: 200px; width: 60px;
            z-index: 50; display: none; /* Aparece só se tocar na tela */
            flex-direction: column; align-items: center;
        }
        input[type=range][orient=vertical] {
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* Webkit */
            width: 100%; height: 100%;
        }
        .label-thr { color: white; font-weight: bold; text-shadow: 1px 1px 0 #000; margin-bottom: 5px; }

        /* DADOS DE VOO */
        #ui-layer {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.6); padding: 10px;
            color: white; border-radius: 8px; font-weight: bold;
            font-family: monospace; font-size: 14px;
            border-left: 4px solid cyan; display: flex; gap: 10px; z-index: 20;
        }
        .data-block { display: flex; flex-direction: column; justify-content: center; }
        #alt-container { width: 10px; height: 80px; background: rgba(0,0,0,0.5); border: 1px solid #555; position: relative; display: flex; align-items: flex-end; }
        #alt-bar { width: 100%; height: 0%; background: cyan; }

        /* LOADING & START */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        button { padding: 20px 40px; font-size: 18px; background: cyan; border: none; cursor: pointer; margin-top: 20px; font-weight: bold; color: black; border-radius: 50px;}
        #instruction { color: #aaa; margin-top: 10px; font-size: 14px; max-width: 80%; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="plane-hud">
        <div id="prop-blur"></div>
        <img id="plane-img" src="https://i.imgur.com/3N40j5c.png">
    </div>

    <div id="mobile-controls">
        <div class="label-thr">THR</div>
        <input type="range" id="throttle-slider" min="0" max="100" value="0" orient="vertical">
    </div>

    <div id="ui-layer">
        <div class="data-block">
            SPD: <span id="val-spd" style="color:cyan">0</span><br>
            ALT: <span id="val-alt" style="color:lime">0</span>
        </div>
        <div id="alt-container"><div id="alt-bar"></div></div>
    </div>

    <div id="overlay">
        <h1 style="color:cyan">FLIGHT SIM MOBILE</h1>
        <p id="status-txt">Carregando satélite...</p>
        <button id="btn-start" onclick="requestMobilePermission()" disabled>AGUARDE...</button>
        <p id="instruction">No iPhone: Use modo Paisagem (Deitado).<br>Incline para pilotar.</p>
    </div>

    <script>
        // CONFIG
        const START_LNG = -47.998; const START_LAT = -23.008; const START_HEADING = 300;
        mapboxgl.accessToken = 'pk.eyJ1IjoiZnRqZGNhbHYiLCJhIjoiY21rY3ZlZXh4MDVzMzNlb3I0djI5NjkwaSJ9.epfqpPvDDLYINXoBJO7iMw'; 

        const map = new mapboxgl.Map({
            container: 'map', style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [START_LNG, START_LAT], zoom: 17, pitch: 75, bearing: START_HEADING,
            antialias: true, interactive: false 
        });

        map.on('load', () => {
            map.addSource('mapbox-dem', { 'type': 'raster-dem', 'url': 'mapbox://mapbox.mapbox-terrain-dem-v1', 'tileSize': 512, 'maxzoom': 14 });
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.0 });
            map.addLayer({ 'id': 'sky', 'type': 'sky', 'paint': { 'sky-type': 'atmosphere', 'sky-atmosphere-sun': [0.0, 90.0], 'sky-atmosphere-sun-intensity': 15 } });

            document.getElementById('status-txt').innerText = "PRONTO PARA DECOLAR";
            const btn = document.getElementById('btn-start');
            btn.innerText = "INICIAR VOO"; btn.disabled = false;
        });

        // INPUTS
        let sim = { lng: START_LNG, lat: START_LAT, head: START_HEADING, spd: 0, alt: 0, thr: 0, pitch: 0, roll: 0, ground: true };
        let mobileTilt = { pitch: 0, roll: 0 };
        let isMobile = false;

        // 1. SOLICITAÇÃO DE PERMISSÃO IOS (Obrigatório)
        function requestMobilePermission() {
            // Mostra o slider se for mobile
            if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
                isMobile = true;
                document.getElementById('mobile-controls').style.display = 'flex';
            }

            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ precisa disso
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            startSim();
                        } else {
                            alert("Permissão negada. O giroscópio não funcionará.");
                            startSim(); // Inicia mesmo sem sensor
                        }
                    })
                    .catch(console.error);
            } else {
                // Android ou iOS antigo
                window.addEventListener('deviceorientation', handleOrientation);
                startSim();
            }
        }

        function handleOrientation(event) {
            // Ajuste para modo paisagem (Landscape)
            // Beta: Inclinação frente/trás (-180 a 180)
            // Gamma: Inclinação esq/dir (-90 a 90)
            
            let pitchRaw = event.beta; 
            let rollRaw = event.gamma;

            // Calibração simples (assumindo que o usuário segura o cel inclinado a 45 graus)
            // Se o usuário estiver segurando confortável, beta é ~45.
            // Queremos que 45 seja o "centro".
            
            if(window.innerHeight < window.innerWidth) {
                // Modo Paisagem
                mobileTilt.pitch = (pitchRaw) * 2; // Sensibilidade
                if(mobileTilt.pitch > 40) mobileTilt.pitch = 40;
                if(mobileTilt.pitch < -40) mobileTilt.pitch = -40;

                mobileTilt.roll = rollRaw * 2; 
            }
        }

        function startSim() { document.getElementById('overlay').style.display = 'none'; loop(); }

        function physics() {
            // INPUT HÍBRIDO: Aceita Joystick OU Celular
            let inputPitch = 0;
            let inputRoll = 0;
            let inputThr = -1;

            // A. Tenta ler Gamepad (PC)
            const gps = navigator.getGamepads ? navigator.getGamepads() : [];
            const gp = gps[0];
            if (gp) {
                if(Math.abs(gp.axes[1]) > 0.05) inputPitch = gp.axes[1] * 25;
                if(Math.abs(gp.axes[0]) > 0.05) inputRoll = gp.axes[0] * 30;
                let axThr = gp.axes[2] ?? gp.axes[5] ?? gp.axes[6] ?? -1;
                if(axThr > -1.1) inputThr = ((axThr * -1) + 1) / 2 * 100;
            }

            // B. Tenta ler Mobile (Se estiver ativo)
            if(isMobile) {
                // O slider HTML controla a aceleração
                let sliderVal = document.getElementById('throttle-slider').value;
                inputThr = parseFloat(sliderVal);
                
                // Giroscópio
                inputPitch = mobileTilt.pitch; 
                inputRoll = mobileTilt.roll;
            }

            // APLICAÇÃO DOS INPUTS
            sim.pitch += (inputPitch - sim.pitch) * 0.1;
            sim.roll += (inputRoll - sim.roll) * 0.1;
            
            // Controle de Potência
            if(inputThr > -1) {
                sim.thr = inputThr;
            }

            // Atualiza Rotação (Heading) baseado no Roll
            if(Math.abs(sim.roll) > 2) {
                sim.head += (sim.roll / 40) * (sim.ground ? 0.5 : 1.5);
            }

            // FÍSICA DE VOO
            let targetSpd = sim.thr * 1.5;
            if(sim.ground) targetSpd *= 0.8; 
            if(!sim.ground) { if(sim.pitch > 5) targetSpd -= 10; if(sim.pitch < -5) targetSpd += 20; }
            sim.spd += (targetSpd - sim.spd) * 0.04;

            if(sim.ground) {
                sim.alt = 0;
                if(sim.spd > 50 && sim.pitch > 5) { sim.ground = false; sim.alt += 5; }
            } else {
                let climbRate = (sim.pitch * 0.5) * (sim.spd / 80);
                if(sim.spd < 45) climbRate *= 0.2;
                sim.alt += climbRate;
                if(sim.alt <= 0) { sim.alt = 0; sim.ground = true; }
            }

            if(sim.spd > 1) {
                const dist = sim.spd * 0.000005; const rad = (sim.head * Math.PI) / 180;
                sim.lng += Math.sin(rad) * dist; sim.lat += Math.cos(rad) * dist;
            }
        }

        function draw() {
            let targetZoom = 17 - (sim.alt / 800); if(targetZoom < 13) targetZoom = 13;
            let targetPitch = Math.max(65, 75 - (sim.alt / 1000));

            map.jumpTo({
                center: [sim.lng, sim.lat], bearing: sim.head, pitch: targetPitch, zoom: targetZoom,
                duration: 0, animate: false 
            });

            const plane = document.getElementById('plane-img');
            const prop = document.getElementById('prop-blur');
            
            let visualPitch = -sim.pitch; 
            plane.style.transform = `rotateZ(${sim.roll}deg) translateY(${visualPitch}px)`;
            
            if(sim.thr > 10) { prop.style.display = 'block'; prop.style.opacity = 0.6 - (sim.thr/200); } 
            else { prop.style.display = 'none'; }

            document.getElementById('val-spd').innerText = Math.floor(sim.spd);
            document.getElementById('val-alt').innerText = Math.floor(sim.alt);
            let altPercent = Math.min(100, (sim.alt / 3000) * 100);
            document.getElementById('alt-bar').style.height = altPercent + "%";
        }

        function loop() { physics(); draw(); requestAnimationFrame(loop); }
    </script>
</body>
</html>
