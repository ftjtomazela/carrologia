<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ATC V14 - BUGFIX EDITION</title>
    <style>
        :root {
            --bg: #000;
            --panel: #111;
            --accent: #00e5ff;
            --atis: #ffca28;
            --gnd: #ff5252;
            --twr: #69f0ae;
            --app: #448aff;
            --acc: #e040fb;
        }

        body {
            background: var(--bg);
            color: #fff;
            font-family: -apple-system, monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0a0a0a;
        }
        .freq-disp { font-size: 1.6rem; font-weight: 800; color: var(--accent); transition: color 0.3s; }
        .stn-lbl { font-size: 0.7rem; color: #666; letter-spacing: 1px; }

        /* ATIS BAR */
        #atis-bar {
            background: #1a1a1a;
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        .atis-btn {
            background: var(--atis); color: #000; border: none; padding: 5px 10px;
            border-radius: 4px; font-weight: bold; font-size: 0.8rem; flex: 1;
        }
        .atis-info { font-size: 0.8rem; color: var(--atis); margin-left: 10px; font-style: italic; display:none; }

        /* LOG AREA */
        #log {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .hidden { display: none !important; }

        .msg { padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; max-width: 90%; line-height: 1.3; }
        .msg.pilot { align-self: flex-end; border-right: 3px solid #fff; background: #222; text-align: right; }
        
        /* Cores ATC */
        .msg.gnd { border-left: 3px solid var(--gnd); color: var(--gnd); background: rgba(255,82,82,0.1); }
        .msg.twr { border-left: 3px solid var(--twr); color: var(--twr); background: rgba(105,240,174,0.1); }
        .msg.app { border-left: 3px solid var(--app); color: var(--app); background: rgba(68,138,255,0.1); }
        .msg.acc { border-left: 3px solid var(--acc); color: var(--acc); background: rgba(224,64,251,0.1); }

        /* DECK */
        #deck {
            background: #151515;
            padding: 15px;
            padding-bottom: 30px; /* Safe area iPhone */
            border-top: 1px solid #333;
        }

        #toggle-hist {
            width: 100%; background: #222; color: #666; border: none; padding: 5px;
            font-size: 0.7rem; margin-bottom: 10px; border-radius: 4px;
        }

        .sug-card {
            background: rgba(255,255,255,0.05);
            border: 1px dashed #444;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .sug-lbl { font-size: 0.7rem; color: #888; font-weight: bold; margin-bottom: 4px; }
        .sug-txt { font-size: 1rem; color: #fff; font-style: italic; }

        .inp-row { display: flex; gap: 8px; height: 45px; }
        input {
            flex: 1; background: #000; border: 1px solid #444; color: #fff;
            padding: 0 10px; border-radius: 6px; font-size: 16px;
        }
        button.send {
            width: 70px; background: var(--accent); color: #000; border: none;
            border-radius: 6px; font-weight: 900;
        }

        /* SETUP */
        #setup { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        .setup-in { padding: 15px; background: #111; border: 1px solid #333; color: #fff; width: 100%; box-sizing: border-box; text-align: center; margin-bottom: 10px; }
        .setup-btn { padding: 15px; background: #007AFF; color: #fff; border: none; width: 100%; font-weight: bold; }

    </style>
</head>
<body>

<div id="setup">
    <h1 style="color:#fff; text-align:center;">ATC V14 (FIXED)</h1>
    <input type="text" id="sb-user" class="setup-in" placeholder="SimBrief Username">
    <button class="setup-btn" onclick="importData()">IMPORTAR DADOS</button>
    <button class="setup-btn" style="background:#333; margin-top:10px;" onclick="startSim()">VOO LIVRE</button>
</div>

<header>
    <div>
        <div class="stn-lbl" id="stn-lbl">OFFLINE</div>
        <div class="freq-disp" id="freq-disp">---.---</div>
    </div>
    <div style="text-align:right;">
        <div class="stn-lbl">CALLSIGN</div>
        <div style="font-weight:bold;" id="cs-disp">PT-AAA</div>
    </div>
</header>

<div id="atis-bar">
    <button class="atis-btn" id="atis-btn" onclick="playATIS()">üîä OUVIR ATIS (SA√çDA)</button>
    <div class="atis-info" id="atis-info">Info Alpha</div>
</div>

<main id="log"></main>

<div id="deck">
    <button id="toggle-hist" onclick="toggleLog()">üîº ESCONDER HIST√ìRICO</button>
    
    <div class="sug-card" onclick="copySug()">
        <div class="sug-lbl">SUGEST√ÉO (TOQUE PARA COPIAR):</div>
        <div class="sug-txt" id="sug-txt">...</div>
    </div>

    <div class="inp-row">
        <input type="text" id="inp" placeholder="Mensagem..." onkeypress="if(event.key==='Enter') send()">
        <button class="send" onclick="send()">ENV</button>
    </div>
</div>

<script>
    // --- DADOS ---
    let f = { 
        callsign: 'N172SB', 
        dep: 'SBMT', arr: 'SBGL', 
        rwy_dep: '12', rwy_arr: '10', 
        sid: 'VETOR', star: 'PIRA1A',
        alt: 'FL140', squawk: '2000',
        atis_dep: 'Alpha', atis_arr: 'Bravo',
        qnh: '1013',
        freqs: { gnd: '121.90', twr: '118.10', app: '129.50', acc: '124.30' }
    };
    
    let step = 0;
    let hasATIS = false;
    let phase = 'DEP'; 

    // --- ROTEIRO COMPLETO (Corrigido para evitar [object]) ---
    const script = [
        { 
            role: 'gnd', hint: 'Requer ATIS', 
            pilot: () => `Solo, ${f.callsign}, informa√ß√£o ${f.atis_dep}, solicita autoriza√ß√£o ${f.arr}.`, 
            key: ['autoriza√ß√£o','alpha'], 
            reply: () => `${f.callsign}, autorizado ${f.arr}, sa√≠da ${f.sid}, n√≠vel 060, transponder ${f.squawk}.`
        },
        { 
            role: 'gnd', hint: 'Cotejar', 
            pilot: () => `Autorizado ${f.arr}, sa√≠da ${f.sid}, 060, ${f.squawk}, ${f.callsign}.`, 
            key: ['autorizado'], 
            reply: () => `${f.callsign}, correto. Chame pronto t√°xi.`
        },
        { 
            role: 'gnd', hint: 'T√°xi', 
            pilot: () => `${f.callsign}, pronto t√°xi.`, 
            key: ['t√°xi'], 
            reply: () => `${f.callsign}, taxie ponto de espera ${f.rwy_dep}. Chame Torre ${f.freqs.twr}.`,
            act: 'twr'
        },
        { 
            role: 'twr', hint: 'Decolagem', 
            pilot: () => `Torre, ${f.callsign}, pronto ponto de espera ${f.rwy_dep}.`, 
            key: ['torre','pronto'], 
            reply: () => `${f.callsign}, autorizado decolagem ${f.rwy_dep}.`
        },
        { 
            role: 'twr', hint: 'Handoff Sa√≠da', 
            pilot: () => `Decolado, ${f.callsign}.`, 
            key: ['decolado'], 
            reply: () => `${f.callsign}, contate Controle Sa√≠da ${f.freqs.app}.`,
            act: 'app'
        },
        { 
            role: 'app', hint: 'Subida', 
            pilot: () => `Controle, ${f.callsign}, passando 3000 p√©s.`, 
            key: ['controle'], 
            reply: () => `${f.callsign}, contato radar. Subida livre n√≠vel ${f.alt}.`
        },
        { 
            role: 'app', hint: 'Handoff Centro', 
            pilot: () => `N√≠vel ${f.alt}, ${f.callsign}.`, 
            key: ['n√≠vel'], 
            reply: () => `${f.callsign}, chame Centro ${f.freqs.acc}.`,
            act: 'acc'
        },
        { 
            role: 'acc', hint: 'Cruzeiro', 
            pilot: () => `Centro, ${f.callsign}, n√≠vel de cruzeiro.`, 
            key: ['centro'], 
            reply: () => `${f.callsign}, ciente. Reporte ideal de descida.`
        },
        { 
            role: 'acc', hint: 'Pedir Descida', 
            pilot: () => `Centro, ${f.callsign}, solicita descida.`, 
            key: ['descida'], 
            reply: () => `${f.callsign}, autorizado descida n√≠vel 100. Chame Controle ${f.freqs.app}.`,
            act: 'app_arr' 
        },
        { 
            role: 'app', hint: 'Descida Inicial', 
            pilot: () => `Controle, ${f.callsign}, descendo n√≠vel 100, info ${f.atis_arr}.`, 
            key: ['descendo','bravo'], 
            reply: () => `${f.callsign}, ciente. Espere vetora√ß√£o ILS pista ${f.rwy_arr}.`
        },
        { 
            role: 'app', hint: 'Intercepta√ß√£o', 
            pilot: () => `Ciente, aguarda vetor ILS ${f.rwy_arr}, ${f.callsign}.`, 
            key: ['ils','vetor'], 
            reply: () => `${f.callsign}, curve direita proa 090, autorizado aproxima√ß√£o. Reporte estabelecido.`
        },
        { 
            role: 'app', hint: 'Handoff Torre', 
            pilot: () => `Estabelecido no localizador, ${f.callsign}.`, 
            key: ['estabelecido'], 
            reply: () => `${f.callsign}, chame Torre ${f.freqs.twr}.`,
            act: 'twr'
        },
        { 
            role: 'twr', hint: 'Final', 
            pilot: () => `Torre, ${f.callsign}, na final ${f.rwy_arr}.`, 
            key: ['torre','final'], 
            reply: () => `${f.callsign}, vento calmo, autorizado pouso ${f.rwy_arr}.`
        },
        { 
            role: 'twr', hint: 'Solo Controlado', 
            pilot: () => `No solo, livrando pista, ${f.callsign}.`, 
            key: ['solo','livrando'], 
            reply: () => `${f.callsign}, bem vindo. Contate Solo ${f.freqs.gnd}.`,
            act: 'gnd'
        },
        { 
            role: 'gnd', hint: 'T√°xi Gate', 
            pilot: () => `Solo, ${f.callsign}, livrou pista, solicita t√°xi p√°tio.`, 
            key: ['solo','t√°xi'], 
            reply: () => `${f.callsign}, taxie via Bravo at√© o p√°tio. Corte a crit√©rio.`
        }
    ];

    // --- FUN√á√ïES DE IMPORTA√á√ÉO (CORRE√á√ÉO DE BUG) ---
    async function importData() {
        const u = document.getElementById('sb-user').value;
        const btn = document.querySelector('.setup-btn');
        if(!u) return alert("Digite usu√°rio");
        
        btn.innerText = "CARREGANDO...";
        
        try {
            const r = await fetch(`https://www.simbrief.com/api/xml.fetcher.php?username=${u}&json=1`);
            const d = await r.json();
            
            // --- AQUI EST√Å A CORRE√á√ÉO DO [OBJECT OBJECT] ---
            
            // 1. Tenta pegar a sigla da cia (GOL, TAM)
            let airline = d.general.icao_airline;
            if(typeof airline === 'object' || !airline) airline = ""; // Se for objeto vazio, vira string vazia
            
            // 2. Tenta pegar o n√∫mero do voo
            let fltNum = d.general.flight_number;
            if(typeof fltNum === 'object' || !fltNum) fltNum = "";

            // 3. Monta o Callsign
            if(airline !== "") {
                f.callsign = airline + fltNum;
            } else {
                // Se n√£o tem airline (Avia√ß√£o Geral), usa a matr√≠cula
                let reg = d.aircraft.reg_num;
                if(typeof reg === 'object' || !reg) reg = "PT-SIM";
                f.callsign = reg;
            }

            // Resto dos dados (com prote√ß√£o)
            f.dep = safeStr(d.origin.icao_code, "SBMT");
            f.arr = safeStr(d.destination.icao_code, "SBGL");
            f.rwy_dep = safeStr(d.origin.plan_rwy, "12");
            f.rwy_arr = safeStr(d.destination.plan_rwy, "10");
            
            // Altitude
            let altRaw = d.general.cruise_altitude;
            if(altRaw && typeof altRaw !== 'object') {
                f.alt = "FL" + Math.round(parseInt(altRaw)/100);
            } else {
                f.alt = "FL100";
            }
            
            startSim();
        } catch(e) { 
            console.error(e);
            alert("Erro ao importar. Verifique se o SimBrief gerou o plano."); 
            btn.innerText = "IMPORTAR DADOS";
        }
    }

    // Fun√ß√£o auxiliar para evitar object
    function safeStr(val, fallback) {
        if(typeof val === 'string' || typeof val === 'number') return val;
        return fallback;
    }

    function startSim() {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('cs-disp').innerText = f.callsign;
        setFreq('gnd');
        updateSug();
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        if(!audioCtx) audioCtx = new AudioContext();
    }

    function toggleLog() {
        const log = document.getElementById('log');
        const btn = document.getElementById('toggle-hist');
        if(log.classList.contains('hidden')) {
            log.classList.remove('hidden');
            btn.innerText = "üîº ESCONDER HIST√ìRICO";
        } else {
            log.classList.add('hidden');
            btn.innerText = "üîΩ MOSTRAR HIST√ìRICO";
        }
    }

    function playATIS() {
        playSquelch();
        let txt = "";
        
        if(phase === 'DEP') {
            txt = `${f.dep}, Informa√ß√£o ${f.atis_dep}. Vento 100 graus 8 n√≥s. QNH ${f.qnh}. Pista em uso ${f.rwy_dep}.`;
            hasATIS = true;
        } else {
            txt = `${f.arr}, Informa√ß√£o ${f.atis_arr}. Vento calmo. QNH ${f.qnh}. Esperar ILS Pista ${f.rwy_arr}.`;
        }

        document.getElementById('atis-info').innerText = phase === 'DEP' ? "Info Alpha" : "Info Bravo";
        document.getElementById('atis-info').style.display = 'block';

        const u = new SpeechSynthesisUtterance(toPhonetic(txt));
        u.lang = 'pt-BR'; u.rate = 1.1; u.pitch = 0.9;
        u.onend = playSquelch;
        window.speechSynthesis.speak(u);
        
        updateSug();
    }

    function send() {
        const i = document.getElementById('inp');
        const t = i.value.trim();
        if(!t) return;
        
        addLog(t, 'pilot');

        if(step < script.length) {
            const s = script[step];
            
            if(s.hint.includes("Requer ATIS") && !hasATIS) {
                 setTimeout(()=>addLog("SISTEMA: Ou√ßa o ATIS primeiro!", 'msg sys'), 500);
                 i.value=''; return;
            }

            if(s.key.some(k=>t.toLowerCase().includes(k)) || t.length>10) {
                setTimeout(()=>{
                    const ans = s.reply();
                    speak(ans, s.role);
                    addLog(ans, s.role);
                    
                    if(s.act) setTimeout(()=>changeMode(s.act), 4000);
                    step++; updateSug();
                }, 1000);
            }
        }
        i.value = '';
    }

    function changeMode(act) {
        if(act === 'app_arr') {
            phase = 'ARR'; 
            setFreq('app');
            const btn = document.getElementById('atis-btn');
            btn.innerText = "üîä OUVIR ATIS (CHEGADA)";
            btn.style.background = "#ff9100";
            addLog(">>> INICIANDO DESCIDA <<<", 'msg sys');
        } else {
            setFreq(act);
        }
    }

    function setFreq(r) {
        const d = document.getElementById('freq-disp');
        const l = document.getElementById('stn-lbl');
        let c='#fff', n='', v='';
        
        if(r==='gnd'){c='var(--gnd)'; n='SOLO'; v=f.freqs.gnd;}
        if(r==='twr'){c='var(--twr)'; n='TORRE'; v=f.freqs.twr;}
        if(r==='app'){c='var(--app)'; n='CONTROLE'; v=f.freqs.app;}
        if(r==='acc'){c='var(--acc)'; n='CENTRO'; v=f.freqs.acc;}

        d.style.color=c; d.innerText=v; l.innerText=n;
        if(audioCtx) playSquelch();
    }

    function updateSug() {
        if(!hasATIS && step===0) document.getElementById('sug-txt').innerText = "(Aguardando ATIS...)";
        else document.getElementById('sug-txt').innerText = step<script.length ? script[step].pilot() : "Voo Finalizado.";
    }
    
    function copySug() { 
        document.getElementById('inp').value = document.getElementById('sug-txt').innerText; 
    }

    function addLog(t, type) {
        const d = document.createElement('div');
        d.className = `msg ${type}`; d.innerText = t;
        const l = document.getElementById('log');
        if(!l.classList.contains('hidden')) {
            l.appendChild(d); l.scrollTop = l.scrollHeight;
        }
    }

    /* AUDIO ENGINE */
    let audioCtx, noise;
    function playSquelch() {
        if(!audioCtx) return;
        const s=audioCtx.createBufferSource(); 
        if(!noise){ noise=audioCtx.createBuffer(1,audioCtx.sampleRate,audioCtx.sampleRate); const d=noise.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*0.2-0.1; }
        s.buffer=noise; const g=audioCtx.createGain(); g.gain.value=0.2;
        g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.2);
        s.connect(g); g.connect(audioCtx.destination); s.start();
    }
    const map={'0':'Zero','1':'Uno','2':'Dois','3':'Tr√™s','4':'Quatro','5':'Cinco','6':'Meia','7':'Sete','8':'Oito','9':'Niner','.':'Decimal'};
    function toPhonetic(t){ return t.replace(/([A-Z]{2}-[A-Z]{3})|(\d{3}\.\d{2})|(\b\d{1,4}\b)|(\d{2}[LRC])/g, m=>m.toUpperCase().split('').map(c=>map[c]||c).join(' ')); }
    function speak(t,r) {
        playSquelch();
        const u=new SpeechSynthesisUtterance(toPhonetic(t)); u.lang='pt-BR';
        if(r==='twr'){u.rate=1.3;u.pitch=1.1;} if(r==='acc'){u.rate=1.1;u.pitch=0.7;}
        const v=window.speechSynthesis.getVoices().find(x=>x.lang.includes('pt-BR')); if(v)u.voice=v;
        u.onend=playSquelch; window.speechSynthesis.speak(u);
    }
    window.speechSynthesis.getVoices();
</script>
</body>
</html>
