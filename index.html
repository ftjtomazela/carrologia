<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATC V11 - STABLE & FULL FLIGHT</title>
    <style>
        :root {
            --bg: #101010;
            --panel: #1e1e1e;
            --border: #333;
            --text: #ddd;
            
            /* Cores de Frequ√™ncia */
            --c-atis: #ffd700; /* Amarelo Ouro */
            --c-gnd: #ef5350;  /* Vermelho */
            --c-twr: #66bb6a;  /* Verde */
            --c-app: #29b6f6;  /* Azul Claro */
            --c-acc: #ab47bc;  /* Roxo (Centro) */
        }

        body {
            font-family: 'Consolas', 'Courier New', monospace;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* HEADER */
        header {
            background: #000;
            padding: 15px;
            border-bottom: 2px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flight-info { font-size: 0.9rem; color: #666; }
        .callsign-box { font-size: 1.5rem; font-weight: bold; color: #fff; letter-spacing: 1px; }

        .radio-box { text-align: right; }
        .freq-val { font-size: 2rem; font-weight: bold; color: #444; transition: color 0.3s; }
        .freq-lbl { font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; color: #666; }

        /* ATIS BAR */
        #atis-bar {
            background: #252525;
            padding: 10px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .atis-btn {
            background: var(--c-atis); color: #000; border: none; padding: 6px 12px;
            font-weight: bold; cursor: pointer; border-radius: 4px; font-size: 0.8rem;
        }
        .atis-marquee { font-size: 0.8rem; color: var(--c-atis); font-style: italic; white-space: nowrap; overflow: hidden; max-width: 60%; }

        /* CHAT AREA */
        main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .msg { padding: 12px; border-radius: 6px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .msg.pilot { align-self: flex-end; border-right: 4px solid #fff; background: rgba(255,255,255,0.05); text-align: right; color: #fff; }
        
        /* Estilos ATC */
        .msg.gnd { border-left: 4px solid var(--c-gnd); color: var(--c-gnd); background: rgba(239, 83, 80, 0.08); }
        .msg.twr { border-left: 4px solid var(--c-twr); color: var(--c-twr); background: rgba(102, 187, 106, 0.08); }
        .msg.app { border-left: 4px solid var(--c-app); color: var(--c-app); background: rgba(41, 182, 246, 0.08); }
        .msg.acc { border-left: 4px solid var(--c-acc); color: var(--c-acc); background: rgba(171, 71, 188, 0.08); }

        /* CONTROL DECK */
        #deck {
            background: var(--panel);
            padding: 15px;
            border-top: 1px solid #333;
        }
        
        .sug-box {
            background: rgba(255,255,255,0.03); border: 1px dashed #444; padding: 10px;
            margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .sug-box:hover { background: rgba(255,255,255,0.08); border-color: #666; }
        
        .input-row { display: flex; gap: 10px; }
        input[type="text"] {
            flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 12px; font-family: inherit; font-size: 1rem;
        }
        button.send-btn {
            background: #eee; color: #000; border: none; padding: 0 25px; font-weight: bold; cursor: pointer;
        }

        /* SETUP OVERLAY */
        #setup { position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: #151515; padding: 30px; width: 320px; text-align: center; border: 1px solid #333; border-radius: 8px; }
        input.setup-in { width: 100%; box-sizing: border-box; margin-bottom: 10px; text-align: center; }
        button.setup-btn { width: 100%; padding: 12px; background: var(--c-app); color: #000; font-weight: bold; border: none; cursor: pointer; margin-top: 5px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="setup">
    <div class="setup-card">
        <h2 style="color:#fff; margin-top:0;">FLIGHT BRIEFING</h2>
        <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">SIMBRIEF USERNAME</div>
        <input type="text" id="sb-user" class="setup-in" placeholder="Ex: JSmith">
        <button class="setup-btn" onclick="fetchSimBrief()">IMPORTAR PLANO</button>
        
        <hr style="border-color:#333; margin:15px 0;">
        
        <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">DADOS MANUAIS (OPCIONAL)</div>
        <input type="text" id="manual-icao" class="setup-in" value="SBGR" placeholder="Origem">
        <input type="text" id="manual-callsign" class="setup-in" value="TAM3304" placeholder="Callsign">
        <button class="setup-btn" style="background:#444; color:#fff;" onclick="startSim()">INICIAR VOO</button>
    </div>
</div>

<header>
    <div>
        <div class="flight-info">FLIGHT DECK</div>
        <div class="callsign-box" id="disp-callsign">---</div>
    </div>
    <div class="radio-box">
        <div class="freq-lbl" id="disp-station">OFFLINE</div>
        <div class="freq-val" id="disp-freq">---.---</div>
    </div>
</header>

<div id="atis-bar">
    <button class="atis-btn" onclick="playATIS()">üîä OUVIR ATIS</button>
    <div class="atis-marquee" id="atis-text">Aguardando sintoniza√ß√£o...</div>
</div>

<main id="chat-log"></main>

<div id="deck">
    <div class="sug-box" onclick="copySug()">
        <div>
            <div style="font-size:0.7rem; color:#666; font-weight:bold;">SUGEST√ÉO (CLIQUE):</div>
            <div style="color:#ccc; font-style:italic;" id="sug-text">...</div>
        </div>
        <span>üìã</span>
    </div>
    <div class="input-row">
        <input type="text" id="inp" placeholder="Mensagem..." onkeypress="if(event.key==='Enter') send()">
        <button class="send-btn" onclick="send()">ENV</button>
    </div>
</div>

<script>
    // --- ESTADO GLOBAL ---
    let flight = {
        callsign: 'TAM3304',
        dep: 'SBGR',
        arr: 'SBGL',
        rwy: '09L',
        sid: 'VETOR',
        alt: 'FL180',
        squawk: '2000',
        atis: 'Alpha',
        qnh: '1013',
        freqs: { gnd: '121.90', twr: '118.10', app: '129.50', acc: '124.30' }
    };
    
    let step = 0;
    let hasATIS = false;
    let audioCtx, noiseNode;

    // --- ROTEIRO INTELIGENTE (Script) ---
    const script = [
        // FASE 1: SOLO (GND)
        { 
            role: 'gnd',
            hint: 'Solicitar Autoriza√ß√£o (Requer ATIS)',
            pilot: () => `Solo, ${flight.callsign}, com informa√ß√£o ${flight.atis}, solicita autoriza√ß√£o para ${flight.arr}.`,
            key: ['autoriza√ß√£o', 'solicita', 'alpha'],
            reply: () => `${flight.callsign}, autorizado ${flight.arr}, sa√≠da ${flight.sid}, n√≠vel inicial 060, transponder ${flight.squawk}.`
        },
        { 
            role: 'gnd',
            hint: 'Cotejamento',
            pilot: () => `Autorizado ${flight.arr}, sa√≠da ${flight.sid}, 060, squawk ${flight.squawk}, ${flight.callsign}.`,
            key: ['autorizado', flight.squawk],
            reply: () => `${flight.callsign}, cotejamento correto. Chame pronto para acionamento.`
        },
        { 
            role: 'gnd',
            hint: 'Acionamento e Pushback',
            pilot: () => `${flight.callsign}, pronto para acionamento e pushback.`,
            key: ['acionamento', 'pushback'],
            reply: () => `${flight.callsign}, acionamento e pushback aprovado. Cauda livre.`
        },
        { 
            role: 'gnd',
            hint: 'T√°xi',
            pilot: () => `${flight.callsign}, pronto para t√°xi.`,
            key: ['t√°xi', 'pronto'],
            reply: () => `${flight.callsign}, taxie via Alfa at√© o ponto de espera pista ${flight.rwy}. Monitorando Torre em ${flight.freqs.twr}.`,
            action: 'switch_twr'
        },
        // FASE 2: TORRE (TWR)
        { 
            role: 'twr',
            hint: 'Ponto de Espera',
            pilot: () => `Torre, ${flight.callsign}, ponto de espera ${flight.rwy}, pronto.`,
            key: ['torre', 'espera'],
            reply: () => `${flight.callsign}, autorizado decolagem pista ${flight.rwy}, vento calmo.`
        },
        // FASE 3: CONTROLE (APP)
        { 
            role: 'twr',
            hint: 'Troca de Frequ√™ncia (Handoff)',
            pilot: () => `Decolado, ${flight.callsign}.`,
            key: ['decolado', 'livrando'],
            reply: () => `${flight.callsign}, contate Controle Sa√≠da em ${flight.freqs.app}.`,
            action: 'switch_app'
        },
        { 
            role: 'app',
            hint: 'Chamada Inicial Controle',
            pilot: () => `Controle, ${flight.callsign}, passando 2500 p√©s.`,
            key: ['controle', 'passando'],
            reply: () => `${flight.callsign}, contato radar. Subida livre para n√≠vel de cruzeiro ${flight.alt}.`
        },
        // FASE 4: CENTRO (ACC) - CRUZEIRO
        { 
            role: 'app',
            hint: 'Troca para Centro (Cruzeiro)',
            pilot: () => `N√≠vel ${flight.alt}, ${flight.callsign}.`,
            key: ['n√≠vel', 'cruzando', 'mantendo'],
            reply: () => `${flight.callsign}, chame Centro Bras√≠lia em ${flight.freqs.acc}. Bom voo.`,
            action: 'switch_acc'
        },
        { 
            role: 'acc',
            hint: 'Chamada Inicial Centro',
            pilot: () => `Centro Bras√≠lia, ${flight.callsign}, mantendo n√≠vel ${flight.alt}.`,
            key: ['centro', 'mantendo'],
            reply: () => `${flight.callsign}, ciente. Mantenha vigil√¢ncia. Reporte pronto para descida.`
        },
        // ... Fim da simula√ß√£o por enquanto ...
        { 
            role: 'acc',
            hint: 'Fim do Voo',
            pilot: () => `(Voo em Cruzeiro...)`,
            key: ['xyz'],
            reply: () => `Fim da Simula√ß√£o.`
        }
    ];

    // --- FUN√á√ïES DE IMPORTA√á√ÉO (BUG FIX) ---
    async function fetchSimBrief() {
        const user = document.getElementById('sb-user').value;
        const btn = document.querySelector('.setup-btn');
        
        if(!user) return alert("Digite o usu√°rio do SimBrief!");
        
        btn.innerText = "CARREGANDO...";
        
        try {
            const url = `https://www.simbrief.com/api/xml.fetcher.php?username=${user}&json=1`;
            const req = await fetch(url);
            const json = await req.json();

            // PARSER SEGURO (Evita [object Object])
            // Usamos o operador ?. (Optional Chaining) para n√£o quebrar se algo faltar
            
            flight.callsign = (json.general?.icao_airline || "") + (json.general?.flight_number || "GEN");
            if(flight.callsign === "GEN") flight.callsign = json.general?.callsign || "PT-SIM"; // Fallback

            flight.dep = json.origin?.icao_code || "SBGR";
            flight.arr = json.destination?.icao_code || "SBGL";
            flight.rwy = json.origin?.plan_rwy || "09L";
            
            // Tenta pegar SID da rota (primeira palavra)
            const rawRoute = json.general?.route || "VETOR";
            flight.sid = rawRoute.split(' ')[0];
            
            // Altitude (Converter p√©s para FL)
            const alt = json.general?.initial_altitude || "18000";
            flight.alt = "FL" + Math.round(parseInt(alt) / 100);

            flight.squawk = "47" + Math.floor(Math.random() * 90 + 10); // Gera Squawk Random

            alert(`Plano Carregado!\nDe: ${flight.dep}\nPara: ${flight.arr}\nAltitude: ${flight.alt}`);
            startSim();

        } catch (e) {
            console.error(e);
            alert("Erro ao ler SimBrief. Verifique se voc√™ gerou o OFP recentemente.");
            btn.innerText = "IMPORTAR PLANO";
        }
    }

    function startSim() {
        // Se n√£o veio do SimBrief, pega dos inputs manuais
        if(document.getElementById('setup').style.display !== 'none') {
            const manCall = document.getElementById('manual-callsign').value;
            if(manCall) flight.callsign = manCall.toUpperCase();
        }

        document.getElementById('setup').style.display = 'none';
        document.getElementById('disp-callsign').innerText = flight.callsign;
        
        initAudio();
        setFreq('gnd'); // Inicia no Solo
        updateSug();
        addLog(`BEM VINDO AO COCKPIT, ${flight.callsign}.`, 'sys');
    }

    // --- L√ìGICA DE CHAT ---
    function send() {
        const inp = document.getElementById('inp');
        const txt = inp.value.trim();
        if(!txt) return;

        addLog(txt, 'pilot');

        if(step < script.length) {
            const st = script[step];
            
            // Valida√ß√µes
            if(st.hint.includes("Requer ATIS") && !hasATIS) {
                setTimeout(() => addLog("SISTEMA: Ou√ßa o ATIS primeiro!", 'sys'), 500);
                inp.value = '';
                return;
            }

            // Verifica keywords
            const hit = st.key.some(k => txt.toLowerCase().includes(k));
            
            if(hit || txt.length > 8) {
                setTimeout(() => {
                    const reply = st.reply();
                    speak(reply, st.role);
                    addLog(reply, st.role);

                    if(st.action) {
                        setTimeout(() => triggerAction(st.action), 4000);
                    }
                    
                    step++;
                    updateSug();
                }, 1000);
            }
        }
        inp.value = '';
    }

    function triggerAction(act) {
        if(act === 'switch_twr') setFreq('twr');
        if(act === 'switch_app') setFreq('app');
        if(act === 'switch_acc') setFreq('acc');
    }

    // --- UI HELPERS ---
    function addLog(txt, role) {
        const d = document.createElement('div');
        if(role === 'sys') {
            d.style.textAlign = 'center'; d.style.color = '#666'; d.style.fontSize = '0.8rem'; d.innerText = txt;
        } else {
            d.className = `msg ${role}`;
            d.innerText = txt;
        }
        const m = document.getElementById('chat-log');
        m.appendChild(d);
        m.scrollTop = m.scrollHeight;
    }

    function updateSug() {
        const el = document.getElementById('sug-text');
        if(!hasATIS && step === 0) {
            el.innerText = "(Aguardando ATIS...)";
            return;
        }
        if(step < script.length) {
            el.innerText = script[step].pilot();
        } else {
            el.innerText = "Voo em Cruzeiro / Monitoramento.";
        }
    }

    function copySug() {
        const t = document.getElementById('sug-text').innerText;
        if(!t.includes("...")) document.getElementById('inp').value = t;
    }

    function setFreq(role) {
        const dv = document.getElementById('disp-freq');
        const dl = document.getElementById('disp-station');
        let c = '#fff', v = '', l = '';

        if(role === 'gnd') { c = 'var(--c-gnd)'; v = flight.freqs.gnd; l = 'SOLO'; }
        if(role === 'twr') { c = 'var(--c-twr)'; v = flight.freqs.twr; l = 'TORRE'; }
        if(role === 'app') { c = 'var(--c-app)'; v = flight.freqs.app; l = 'CONTROLE'; }
        if(role === 'acc') { c = 'var(--c-acc)'; v = flight.freqs.acc; l = 'CENTRO'; }

        dv.style.color = c; 
        dv.innerText = v; 
        dl.innerText = l;
        
        if(audioCtx) playSquelch();
        addLog(`>>> R√ÅDIO: ${l} (${v}) <<<`, 'sys');
    }

    // --- ATIS & AUDIO ---
    function playATIS() {
        if(!audioCtx) initAudio();
        playSquelch();
        
        const txt = `${flight.dep}, Informa√ß√£o ${flight.atis}. Hora 1400 Zulu. Vento 110 graus, 8 n√≥s. Visibilidade maior que 10 quil√¥metros. Teto 4 mil p√©s. Temperatura 28. QNH ${flight.qnh}. Informe ${flight.atis} no contato inicial.`;
        
        document.getElementById('atis-text').innerText = txt;
        
        const u = new SpeechSynthesisUtterance(toPhonetic(txt));
        u.lang = 'pt-BR';
        u.rate = 1.1;
        u.pitch = 0.9; // Rob√≥tico
        
        u.onend = () => { playSquelch(); hasATIS = true; updateSug(); };
        window.speechSynthesis.speak(u);
    }

    // Motor Fon√©tico e Efeitos
    const phMap = {'0':'Zero','1':'Uno','2':'Dois','3':'Tr√™s','4':'Quatro','5':'Cinco','6':'Meia','7':'Sete','8':'Oito','9':'Niner','.':'Decimal'};
    
    function toPhonetic(str) {
        return str.replace(/([A-Z]{2}-[A-Z]{3})|(\d{3}\.\d{2})|(\b\d{1,4}\b)|(\d{2}[LRC])/g, m => {
            return m.toUpperCase().split('').map(c => phMap[c] || c).join(' ');
        });
    }

    function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const b = audioCtx.createBuffer(1, audioCtx.sampleRate, audioCtx.sampleRate);
        const d = b.getChannelData(0);
        for(let i=0; i<d.length; i++) d[i] = Math.random() * 0.15 - 0.075;
        noiseNode = b;
    }

    function playSquelch() {
        if(!audioCtx) return;
        const s = audioCtx.createBufferSource(); s.buffer = noiseNode;
        const g = audioCtx.createGain(); g.gain.value = 0.2;
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
        s.connect(g); g.connect(audioCtx.destination); s.start();
    }

    function speak(txt, role) {
        playSquelch();
        const u = new SpeechSynthesisUtterance(toPhonetic(txt));
        u.lang = 'pt-BR';
        
        if(role === 'gnd') { u.rate=1.1; u.pitch=1.0; }
        if(role === 'twr') { u.rate=1.3; u.pitch=1.2; } // Torre Aguda/R√°pida
        if(role === 'app') { u.rate=1.0; u.pitch=0.8; } // Controle Grave
        if(role === 'acc') { u.rate=1.1; u.pitch=0.7; } // Centro Muito Grave

        // Tentar pegar voz Google
        const voices = window.speechSynthesis.getVoices();
        const v = voices.find(vo => vo.name.includes("Google") && vo.lang.includes("pt-BR")) || voices.find(vo => vo.lang.includes("pt-BR"));
        if(v) u.voice = v;

        u.onend = playSquelch;
        window.speechSynthesis.speak(u);
    }
    
    window.speechSynthesis.getVoices(); // Pr√©-carregar

</script>
</body>
</html>
