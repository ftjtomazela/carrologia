<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDS - Cozinha Dona Baguete</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1f2937;
            color: #f3f4f6;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #d4a021;
            margin-bottom: 25px;
            font-size: 2.5rem;
        }
        .kds-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            overflow-x: auto;
            min-height: 90vh;
        }
        .kds-coluna {
            background: #374151;
            border-radius: 12px;
            width: 380px;
            min-width: 380px;
            padding: 15px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .kds-coluna h2 {
            font-size: 1.3rem;
            color: #d4a021;
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 2px solid #4b5563;
        }
        .pedidos-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 75vh;
            overflow-y: auto;
        }
        .pedido-card {
            background: #4b5563;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #5e6c80;
            transition: all 0.3s;
        }
        .pedido-card.novo {
            border-color: #10b981;
            animation: piscarBorda 1.5s 3;
        }
        @keyframes piscarBorda {
            0%, 100% { border-color: #10b981; }
            50% { border-color: #d4a021; }
        }
        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .pedido-cliente {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
        }
        .pedido-hora {
            font-size: 0.9rem;
            color: #9ca3af;
        }
        .pedido-itens ul {
            list-style: none;
            padding-left: 10px;
            margin-bottom: 15px;
        }
        .pedido-itens li {
            font-size: 1rem;
            color: #e5e7eb;
            margin-bottom: 8px;
            border-bottom: 1px dashed #5e6c80;
            padding-bottom: 8px;
        }
        .item-detalhes {
            font-size: 0.85rem;
            color: #d1d5db;
            padding-left: 10px;
        }
        .pedido-info {
            background: #374151;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .info-row span:first-child { color: #9ca3af; }
        .info-row span:last-child { color: #e5e7eb; font-weight: bold; }
        .info-row.total {
            font-size: 1.1rem;
            border-top: 1px solid #5e6c80;
            padding-top: 8px;
            margin-top: 8px;
        }
        .info-row.total span:last-child { color: #d4a021; }
        .pedido-acoes {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-kds {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-kds.preparo { background: #d4a021; color: #000; }
        .btn-kds.pronto { background: #10b981; color: #fff; }
        .btn-kds.finalizar { background: #ef4444; color: #fff; }
    </style>
</head>
<body>

    <audio id="audio-novo-pedido" src="https://www.myinstants.com/media/sounds/notification-sound.mp3" preload="auto"></audio>

    <h1>üñ•Ô∏è Cozinha - Dona Baguete</h1>

    <div class="kds-container">
        <div class="kds-coluna" id="coluna-pendente">
            <h2>üîî Novos Pedidos</h2>
            <div class="pedidos-container" id="container-pendente">
                </div>
        </div>

        <div class="kds-coluna" id="coluna-preparo">
            <h2>üç≥ Em Preparo</h2>
            <div class="pedidos-container" id="container-preparo">
                </div>
        </div>

        <div class="kds-coluna" id="coluna-pronto">
            <h2>‚úÖ Prontos (Entrega/Retirada)</h2>
            <div class="pedidos-container" id="container-pronto">
                </div>
        </div>
    </div>

    <script type="module">
        // Importa as fun√ß√µes necess√°rias do Firebase v12
        // ‚≠ê MUDAN√áA 1: Adicionamos 'get' e 'set' para poder LER e ESCREVER o hist√≥rico
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getDatabase, ref, onChildAdded, onChildChanged, onChildRemoved, update, remove, get, set } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        // Sua configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAQTm3cL26REQloN8AFP28gwsIUzYz73og",
            authDomain: "dona-baguete-kds.firebaseapp.com",
            databaseURL: "https://dona-baguete-kds-default-rtdb.firebaseio.com",
            projectId: "dona-baguete-kds",
            storageBucket: "dona-baguete-kds.firebasestorage.app",
            messagingSenderId: "307283406823",
            appId: "1:307283406823:web:a7d1761f0b4550cae59742",
            measurementId: "G-NY4NTLFLCG"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app); 
        const pedidosRef = ref(database, 'pedidos'); 

        // ‚≠ê MUDAN√áA 2: Criamos a refer√™ncia para o novo local do hist√≥rico
        const historicoRef = ref(database, 'pedidos_concluidos');

        // Fun√ß√£o para tocar o som de notifica√ß√£o
        function tocarNotificacao() {
            const audio = document.getElementById('audio-novo-pedido');
            audio.currentTime = 0; 
            audio.play().catch(e => console.log("N√£o foi poss√≠vel tocar o som:", e));
        }

        // Fun√ß√£o para formatar os itens do pedido em HTML
        function formatarItens(itens) {
            if (!itens) return '';
            return '<ul>' + itens.map(item => {
                let detalhes = '';
                if (item.queijo) detalhes += `<div class="item-detalhes">üßÄ Queijo: ${item.queijo}</div>`;
                if (item.sabor) detalhes += `<div class="item-detalhes">ü•§ Sabor: ${item.sabor}</div>`;
                if (item.adicionais && item.adicionais.length > 0) {
                    detalhes += `<div class="item-detalhes">‚ûï ${item.adicionais.map(ad => ad.nome).join(', ')}</div>`;
                }
                if (item.remocoes && item.remocoes.length > 0) {
                    detalhes += `<div class="item-detalhes">‚ûñ ${item.remocoes.map(rem => rem.nome).join(', ')}</div>`;
                }
                if (item.observacao) {
                    detalhes += `<div class="item-detalhes">üìù Obs: ${item.observacao}</div>`;
                }
                return `<li><strong>${item.quantidade}x ${item.nome}</strong>${detalhes}</li>`;
            }).join('') + '</ul>';
        }

        // Fun√ß√£o para formatar os bot√µes de a√ß√£o (agora usa data- attributes)
        function formatarAcoes(pedidoId, status) {
            if (status === 'Pendente') {
                return `<button class="btn-kds preparo" data-id="${pedidoId}" data-status="Em Preparo">Mover para Preparo üç≥</button>`;
            }
            if (status === 'Em Preparo') {
                return `<button class="btn-kds pronto" data-id="${pedidoId}" data-status="Pronto">Mover para Pronto ‚úÖ</button>`;
            }
            if (status === 'Pronto') {
                return `<button class="btn-kds finalizar" data-id="${pedidoId}">Finalizar Pedido üóëÔ∏è</button>`;
            }
            return '';
        }

        function renderizarPedido(pedido, pedidoId, ehNovo = false) {
            const horaFormatada = new Date(pedido.hora).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            const cardHTML = `
                <div class="pedido-card ${ehNovo ? 'novo' : ''}" 
                        id="${pedidoId}" 
                        data-cliente-nome="${pedido.cliente.nome}" 
                        data-cliente-wa="${pedido.cliente.whatsapp}"
                        data-entrega-tipo="${pedido.entrega.tipo}">
                    
                    <div class="pedido-header">
                        <span class="pedido-cliente">${pedido.cliente.nome}</span>
                        <span class="pedido-hora">${horaFormatada}</span>
                    </div>
                    <div class="pedido-itens">
                        ${formatarItens(pedido.itens)}
                    </div>
                    
                    <div class="pedido-info">
                        <div class="info-row">
                            <span>üìû WhatsApp:</span>
                            <span>${pedido.cliente.whatsapp}</span>
                        </div>
                        <div class="info-row">
                            <span>üìç Entrega:</span>
                            <span>${pedido.entrega.tipo === 'retirada' ? 'Retirada' : pedido.entrega.endereco}</span>
                        </div>
                        <div class="info-row">
                            <span>üí≥ Pagamento:</span>
                            <span>${pedido.pagamento}</span>
                        </div>
                        <div class="info-row total">
                            <span>TOTAL:</span>
                            <span>R$ ${pedido.total.toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                    
                    <div class="pedido-acoes">
                        ${formatarAcoes(pedidoId, pedido.status)}
                    </div>
                </div>
            `;

            const cardAntigo = document.getElementById(pedidoId);
            if (cardAntigo) cardAntigo.remove();

            let container;
            if (pedido.status === 'Pendente') {
                container = document.getElementById('container-pendente');
            } else if (pedido.status === 'Em Preparo') {
                container = document.getElementById('container-preparo');
            } else if (pedido.status === 'Pronto') {
                container = document.getElementById('container-pronto');
            }
            
            if (container) {
                container.insertAdjacentHTML('afterbegin', cardHTML);
            }
        }
        
        // --- OUVINTES DO FIREBASE (Sintaxe v12) ---

        onChildAdded(pedidosRef, (snapshot) => {
            const pedido = snapshot.val();
            const pedidoId = snapshot.key;
            
            if(pedido.status === 'Pendente') {
                tocarNotificacao();
                renderizarPedido(pedido, pedidoId, true);
            } else {
                renderizarPedido(pedido, pedidoId, false);
            }
        });

        onChildChanged(pedidosRef, (snapshot) => {
            const pedido = snapshot.val();
            const pedidoId = snapshot.key;
            renderizarPedido(pedido, pedidoId, false);
        });

        onChildRemoved(pedidosRef, (snapshot) => {
            const pedidoId = snapshot.key;
            const card = document.getElementById(pedidoId);
            if (card) {
                card.remove();
            }
        });

        // --- FUN√á√ïES DE A√á√ÉO (Sintaxe v12) ---
        
        function moverPedido(pedidoId, novoStatus) {
            const pedidoParaAtualizar = ref(database, 'pedidos/' + pedidoId);
            update(pedidoParaAtualizar, {
                status: novoStatus
            });
        }
        
        // ‚≠ê MUDAN√áA 3: Fun√ß√£o 'finalizarPedido' totalmente modificada
        // Agora ela L√ä, ESCREVE no hist√≥rico e DEPOIS apaga.
        function finalizarPedido(pedidoId) {
            if (confirm('Tem certeza que deseja finalizar e ARQUIVAR este pedido?')) {
                
                const pedidoParaRemoverRef = ref(database, 'pedidos/' + pedidoId);
                
                // 1. LER o pedido da lista 'pedidos'
                get(pedidoParaRemoverRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const pedidoData = snapshot.val();
                        
                        // 2. CRIAR uma nova refer√™ncia no hist√≥rico ('pedidos_concluidos')
                        //    Usamos a mesma ID (pedidoId) para manter o registro
                        const destinoRef = ref(database, 'pedidos_concluidos/' + pedidoId);
                        
                        // 3. ESCREVER (set) o pedido no hist√≥rico
                        set(destinoRef, pedidoData).then(() => {
                            // 4. Se a escrita deu certo, REMOVER o pedido da fila original
                            remove(pedidoParaRemoverRef);
                        }).catch((error) => {
                            console.error("Erro ao MOVER o pedido (escrita no hist√≥rico): ", error);
                            alert("Erro ao arquivar o pedido.");
                        });

                    } else {
                        // Se n√£o encontrou (ex: outro usu√°rio j√° finalizou), apenas remove da fila
                        console.log("Pedido n√£o encontrado, talvez j√° tenha sido removido.");
                        remove(pedidoParaRemoverRef);
                    }
                }).catch((error) => {
                    console.error("Erro ao MOVER o pedido (leitura): ", error);
                    alert("Erro ao ler o pedido para arquivar.");
                });
            }
        }

        document.addEventListener('click', (e) => {
            const button = e.target;
            
            // --- A√ß√£o de Mover (Preparo ou Pronto) ---
            if (button.matches('.btn-kds.preparo') || button.matches('.btn-kds.pronto')) {
                const card = button.closest('.pedido-card');
                const pedidoId = button.dataset.id;
                const novoStatus = button.dataset.status;
                
                // Pega os dados do cliente que salvamos no card
                const clienteNome = card.dataset.clienteNome;
                const clienteWa = card.dataset.clienteWa;
                const tipoEntrega = card.dataset.entregaTipo; // 'retirada', 'dentro', 'fora'

                let mensagem = "";

                if (novoStatus === 'Em Preparo') {
                    mensagem = `Ol√°, ${clienteNome}! üëã Seu pedido na Dona Baguete foi confirmado e j√° est√° *em preparo*! üç≥`;
                } else if (novoStatus === 'Pronto') {
                    if (tipoEntrega === 'retirada') {
                        mensagem = `Ol√°, ${clienteNome}! üëã Boas not√≠cias! Seu pedido na Dona Baguete est√° *pronto para retirada*! üìç\n\nNosso endere√ßo: Rua Romualdo Albino Balestrin, 35 - COHAB III`;
                    } else {
                        mensagem = `Ol√°, ${clienteNome}! üëã Boas not√≠cias! Seu pedido na Dona Baguete est√° *pronto* e j√° est√° saindo para entrega! üõµ`;
                    }
                }

                // Pergunta ao usu√°rio se quer notificar
                if (mensagem) {
                    const notificar = confirm(`Deseja NOTIFICAR o cliente "${clienteNome}" no WhatsApp sobre essa mudan√ßa?`);
                    
                    if (notificar) {
                        const whatsappUrl = `https://wa.me/${clienteWa}?text=${encodeURIComponent(mensagem)}`;
                        window.open(whatsappUrl, '_blank');
                    }
                }
                
                // Move o pedido no KDS (independentemente de ter notificado ou n√£o)
                moverPedido(pedidoId, novoStatus);
            }
            
            // --- A√ß√£o de Finalizar ---
            if (button.matches('.btn-kds.finalizar')) {
                finalizarPedido(button.dataset.id); // A fun√ß√£o finalizarPedido j√° tem um 'confirm'
            }
        });

    </script>
</body>
</html>
