<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ATC V16 - iOS FIX</title>
    <style>
        :root {
            --bg: #000; --panel: #111; --accent: #00e5ff;
            --atis: #ffca28; --gnd: #ff5252; --twr: #69f0ae; --app: #448aff; --acc: #e040fb;
        }
        
        * { box-sizing: border-box; }

        body { 
            background: var(--bg); 
            color: #fff; 
            font-family: -apple-system, monospace; 
            margin: 0; 
            /* O SEGREDO DO IPHONE: svh (Small Viewport Height) */
            height: 100svh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        /* HEADER */
        header { 
            padding: 10px 15px; 
            padding-top: max(10px, env(safe-area-inset-top)); /* Respeita o Notch */
            border-bottom: 1px solid #333; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #0a0a0a;
            flex-shrink: 0; /* Não deixa encolher */
        }
        .freq-disp { font-size: 1.6rem; font-weight: 800; color: var(--accent); }
        .stn-lbl { font-size: 0.7rem; color: #666; letter-spacing: 1px; }

        /* TABS */
        .tabs { display: flex; background: #1a1a1a; border-bottom: 1px solid #333; flex-shrink: 0; }
        .tab { flex: 1; padding: 12px; text-align: center; color: #666; font-weight: bold; font-size: 0.8rem; cursor: pointer; }
        .tab.active { color: #fff; background: #222; border-bottom: 2px solid var(--accent); }

        /* CONTEÚDO (Scrollável) */
        #main-content { 
            flex: 1; 
            position: relative; 
            overflow: hidden; 
            background: #050505;
        }
        .page { position: absolute; inset: 0; display: none; flex-direction: column; }
        .page.active { display: flex; }

        /* PÁGINA COMMS */
        #atis-bar { 
            background: #1a1a1a; 
            padding: 8px; 
            display: flex; 
            gap: 10px;
            align-items: center; 
            border-bottom: 1px solid #333; 
            flex-shrink: 0;
        }
        .atis-btn { background: var(--atis); color: #000; border: none; padding: 8px; border-radius: 6px; font-weight: bold; font-size: 0.8rem; flex: 1; }
        
        #log { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
            padding-bottom: 20px;
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            -webkit-overflow-scrolling: touch; /* Scroll suave no iOS */
        }
        
        .msg { padding: 10px 14px; border-radius: 8px; font-size: 0.95rem; max-width: 85%; line-height: 1.4; }
        .msg.pilot { align-self: flex-end; border-right: 3px solid #fff; background: #222; text-align: right; }
        .msg.sys { align-self: center; color: #555; font-size: 0.75rem; font-style: italic; }
        
        /* Cores ATC */
        .msg.gnd { border-left: 3px solid var(--gnd); color: var(--gnd); background: rgba(255,82,82,0.1); }
        .msg.twr { border-left: 3px solid var(--twr); color: var(--twr); background: rgba(105,240,174,0.1); }
        .msg.app { border-left: 3px solid var(--app); color: var(--app); background: rgba(68,138,255,0.1); }
        .msg.acc { border-left: 3px solid var(--acc); color: var(--acc); background: rgba(224,64,251,0.1); }

        /* PÁGINA MAPA */
        #map-container { height: 100%; display: flex; align-items: center; justify-content: center; }
        #map-img { max-width: 100%; max-height: 100%; }
        .no-map { color: #444; padding: 20px; text-align: center; }

        /* RODAPÉ (FIXO) */
        #deck { 
            background: #151515; 
            padding: 10px; 
            border-top: 1px solid #333;
            flex-shrink: 0;
            /* Garante que fique acima da barra home do iPhone */
            padding-bottom: max(15px, env(safe-area-inset-bottom)); 
        }

        .sug-card { 
            background: rgba(255,255,255,0.05); border: 1px dashed #444; 
            padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; 
        }
        .sug-lbl { font-size: 0.7rem; color: #888; font-weight: bold; margin-bottom: 4px; }
        .sug-txt { font-size: 0.95rem; color: #fff; font-style: italic; }
        
        .inp-row { display: flex; gap: 8px; height: 44px; }
        input { 
            flex: 1; background: #000; border: 1px solid #444; color: #fff; 
            padding: 0 12px; border-radius: 8px; font-size: 16px; /* Evita zoom automático no input */
        }
        button.send { width: 70px; background: var(--accent); color: #000; border: none; border-radius: 8px; font-weight: 800; }

        /* SETUP MODAL */
        #setup { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; padding: 30px; padding-bottom: 20%; }
        .setup-in { padding: 15px; background: #111; border: 1px solid #333; color: #fff; width: 100%; box-sizing: border-box; text-align: center; margin-bottom: 10px; border-radius: 8px; }
        .setup-btn { padding: 15px; background: #007AFF; color: #fff; border: none; width: 100%; font-weight: bold; border-radius: 8px; }
        .resume-btn { padding: 15px; background: var(--twr); color: #000; border: none; width: 100%; font-weight: bold; border-radius: 8px; margin-bottom: 10px; display: none; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="setup">
    <h2 style="color:#fff; text-align:center;">EFB V16 (iOS)</h2>
    <button id="resume-btn" class="resume-btn" onclick="resumeFlight()">↩ RETOMAR VOO</button>
    <input type="text" id="sb-user" class="setup-in" placeholder="SimBrief Username">
    <button class="setup-btn" onclick="importData()">IMPORTAR (SIMBRIEF)</button>
    <button class="setup-btn" style="background:#333; margin-top:10px;" onclick="startSim()">VOO LIVRE</button>
</div>

<header>
    <div>
        <div class="stn-lbl" id="stn-lbl">OFFLINE</div>
        <div class="freq-disp" id="freq-disp">---.---</div>
    </div>
    <div style="text-align:right;">
        <div class="stn-lbl">CALLSIGN</div>
        <div style="font-weight:bold;" id="cs-disp">N/A</div>
    </div>
</header>

<div class="tabs">
    <div class="tab active" onclick="switchTab('comms')">COMMS</div>
    <div class="tab" onclick="switchTab('map')">MAPA</div>
</div>

<div id="main-content">
    <div id="page-comms" class="page active">
        <div id="atis-bar">
            <button class="atis-btn" id="atis-btn" onclick="fetchRealATIS()">☁️ METAR REAL</button>
            <div style="font-size:0.8rem; color:#888; display:none;" id="atis-info">...</div>
        </div>
        <div id="log"></div>
    </div>

    <div id="page-map" class="page">
        <div id="map-container">
            <div class="no-map">Sem mapa disponível.</div>
        </div>
    </div>
</div>

<div id="deck">
    <div class="sug-card" onclick="copySug()">
        <div class="sug-lbl">TOQUE PARA COPIAR:</div>
        <div class="sug-txt" id="sug-txt">...</div>
    </div>
    <div class="inp-row">
        <input type="text" id="inp" placeholder="Mensagem..." onkeypress="if(event.key==='Enter') send()">
        <button class="send" onclick="send()">ENV</button>
    </div>
</div>

<script>
    // --- ESTADO ---
    let f = { callsign: 'PT-IOS', dep: 'SBMT', arr: 'SBGL', rwy_dep: '12', rwy_arr: '10', sid: 'VETOR', alt: 'FL140', squawk: '2000', map_url: '', freqs: { gnd: '121.90', twr: '118.10', app: '129.50', acc: '124.30' } };
    let state = { step: 0, hasATIS: false, phase: 'DEP' };

    // --- ROTEIRO ---
    const script = [
        { role: 'gnd', hint: 'Requer ATIS', pilot: () => `Solo, ${f.callsign}, info ${state.phase==='DEP'?'Alpha':'Bravo'}, solicita autorização.`, key: ['autorização','alpha'], reply: () => `${f.callsign}, autorizado ${f.arr}, saída ${f.sid}, nível 060, squawk ${f.squawk}.` },
        { role: 'gnd', hint: 'Cotejar', pilot: () => `Autorizado ${f.arr}, saída ${f.sid}, 060, ${f.squawk}, ${f.callsign}.`, key: ['autorizado'], reply: () => `${f.callsign}, correto. Chame pronto táxi.` },
        { role: 'gnd', hint: 'Táxi', pilot: () => `${f.callsign}, pronto táxi.`, key: ['táxi'], reply: () => `${f.callsign}, taxie ponto de espera ${f.rwy_dep}. Chame Torre ${f.freqs.twr}.`, act: 'twr' },
        { role: 'twr', hint: 'Decolagem', pilot: () => `Torre, ${f.callsign}, pronto espera ${f.rwy_dep}.`, key: ['torre','pronto'], reply: () => `${f.callsign}, autorizado decolagem ${f.rwy_dep}.` },
        { role: 'twr', hint: 'Handoff', pilot: () => `Decolado, ${f.callsign}.`, key: ['decolado'], reply: () => `${f.callsign}, contate Controle ${f.freqs.app}.`, act: 'app' },
        { role: 'app', hint: 'Subida', pilot: () => `Controle, ${f.callsign}, subindo.`, key: ['controle'], reply: () => `${f.callsign}, contato radar. Subida livre nível ${f.alt}.` },
        { role: 'app', hint: 'Handoff ACC', pilot: () => `Nível ${f.alt}, ${f.callsign}.`, key: ['nível'], reply: () => `${f.callsign}, chame Centro ${f.freqs.acc}.`, act: 'acc' },
        { role: 'acc', hint: 'Cruzeiro', pilot: () => `Centro, ${f.callsign}, nível de cruzeiro.`, key: ['centro'], reply: () => `${f.callsign}, ciente. Reporte ideal de descida.` },
        { role: 'acc', hint: 'Descida', pilot: () => `Centro, ${f.callsign}, solicita descida.`, key: ['descida'], reply: () => `${f.callsign}, autorizado descida FL100. Chame Controle ${f.freqs.app}.`, act: 'app_arr' },
        { role: 'app', hint: 'Aproximação', pilot: () => `Controle, ${f.callsign}, descendo FL100, info Bravo.`, key: ['descendo','bravo'], reply: () => `${f.callsign}, espere vetoração ILS ${f.rwy_arr}.` },
        { role: 'app', hint: 'Intercept', pilot: () => `Ciente, aguarda vetor ${f.rwy_arr}, ${f.callsign}.`, key: ['ils','vetor'], reply: () => `${f.callsign}, curve direita proa 090, autorizado aproximação. Reporte estabelecido.` },
        { role: 'app', hint: 'Estabelecido', pilot: () => `Estabelecido, ${f.callsign}.`, key: ['estabelecido'], reply: () => `${f.callsign}, chame Torre ${f.freqs.twr}.`, act: 'twr' },
        { role: 'twr', hint: 'Final', pilot: () => `Torre, ${f.callsign}, na final ${f.rwy_arr}.`, key: ['torre','final'], reply: () => `${f.callsign}, livre pouso ${f.rwy_arr}.` },
        { role: 'twr', hint: 'Solo', pilot: () => `No solo, livrando, ${f.callsign}.`, key: ['solo','livrando'], reply: () => `${f.callsign}, bem vindo. Contate Solo ${f.freqs.gnd}.`, act: 'gnd' },
        { role: 'gnd', hint: 'Gate', pilot: () => `Solo, ${f.callsign}, solicita táxi pátio.`, key: ['solo','táxi'], reply: () => `${f.callsign}, taxie via Bravo. Corte a critério.` }
    ];

    // --- FUNÇÕES ---
    window.onload = () => {
        if(localStorage.getItem('atc_s')) {
            document.getElementById('resume-btn').style.display = 'block';
            document.getElementById('sb-user').value = localStorage.getItem('sb_u') || '';
        }
    };

    async function importData() {
        const u = document.getElementById('sb-user').value;
        const btn = document.querySelector('.setup-btn');
        if(!u) return alert("Digite usuário");
        btn.innerText = "CARREGANDO...";
        
        try {
            const r = await fetch(`https://www.simbrief.com/api/xml.fetcher.php?username=${u}&json=1`);
            const d = await r.json();
            
            // Tratamento de dados seguro
            let al = d.general.icao_airline || "";
            let num = d.general.flight_number || "";
            f.callsign = (al && typeof al==='string') ? al+num : (d.aircraft.reg_num || "PT-SIM");
            
            f.dep = d.origin.icao_code || "SBMT"; f.arr = d.destination.icao_code || "SBGL";
            f.rwy_dep = d.origin.plan_rwy || "12"; f.rwy_arr = d.destination.plan_rwy || "10";
            f.alt = "FL" + Math.round((parseInt(d.general.cruise_altitude)||14000)/100);
            f.map_url = d.images?.directory ? `${d.images.directory}${d.images.map[0].link}` : "";

            state = { step: 0, hasATIS: false, phase: 'DEP' };
            localStorage.setItem('sb_u', u);
            startSim();
        } catch(e) { console.error(e); alert("Erro ao importar."); btn.innerText = "IMPORTAR"; }
    }

    function resumeFlight() {
        if(localStorage.getItem('atc_f')) {
            f = JSON.parse(localStorage.getItem('atc_f'));
            state = JSON.parse(localStorage.getItem('atc_s'));
            startSim(true);
        }
    }

    function startSim(resumed = false) {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('cs-disp').innerText = f.callsign;
        
        if(f.map_url) document.getElementById('map-container').innerHTML = `<img id="map-img" src="${f.map_url}">`;
        
        // Restaura frequência
        let r = 'gnd';
        if(state.step>=3) r='twr'; if(state.step>=5) r='app'; if(state.step>=7) r='acc';
        if(state.step>=9) r='app'; if(state.step>=12) r='twr'; if(state.step>=14) r='gnd';
        
        setFreq(r, false);
        updateSug();
        initAudio();
        addLog(resumed ? ">>> VOO RESTAURADO <<<" : `>>> BEM VINDO, ${f.callsign} <<<`, 'sys');
        saveState();
    }

    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
        if(t === 'comms') { document.querySelector('.tab:nth-child(1)').classList.add('active'); document.getElementById('page-comms').classList.add('active'); } 
        else { document.querySelector('.tab:nth-child(2)').classList.add('active'); document.getElementById('page-map').classList.add('active'); }
    }

    async function fetchRealATIS() {
        playSquelch();
        const icao = state.phase === 'DEP' ? f.dep : f.arr;
        const btn = document.getElementById('atis-btn');
        btn.innerText = "BUSCANDO...";
        try {
            const r = await fetch(`https://metar.vatsim.net/metar.php?id=${icao}`);
            const m = await r.text();
            const wind = m.match(/(\d{3}|VRB)(\d{2,3})KT/) || ["", "Calmo", ""];
            const qnh = m.match(/Q(\d{4})/) || ["", "1013"];
            let txt = `${icao} Info ${state.phase==='DEP'?'Alpha':'Bravo'}. Vento ${wind[1]} ${wind[2]}kt. QNH ${qnh[1]}.`;
            speak(txt, 'atis');
            state.hasATIS = true;
            btn.innerText = state.phase === 'DEP' ? "SAÍDA (Alpha)" : "CHEGADA (Bravo)";
            updateSug(); saveState();
        } catch(e) { speak("Erro Metar. Info Alpha.", 'atis'); state.hasATIS=true; updateSug(); }
    }

    function send() {
        const i = document.getElementById('inp');
        const t = i.value.trim();
        if(!t) return;
        addLog(t, 'pilot');
        if(state.step < script.length) {
            const s = script[state.step];
            if(s.hint.includes("Requer ATIS") && !state.hasATIS) { setTimeout(()=>addLog("⚠️ Ouça o METAR!", 'sys'), 500); i.value=''; return; }
            if(s.key.some(k=>t.toLowerCase().includes(k)) || t.length>8) {
                setTimeout(()=>{
                    const ans = s.reply(); speak(ans, s.role); addLog(ans, s.role);
                    if(s.act) setTimeout(()=>changeMode(s.act), 4000);
                    state.step++; updateSug(); saveState();
                }, 1000);
            }
        }
        i.value = '';
    }

    function changeMode(act) {
        if(act === 'app_arr') {
            state.phase = 'ARR'; setFreq('app');
            const btn = document.getElementById('atis-btn');
            btn.innerText = "☁️ METAR CHEGADA"; btn.style.background = "#ff9100";
        } else { setFreq(act); }
        saveState();
    }

    function setFreq(r, snd=true) {
        const d=document.getElementById('freq-disp'), l=document.getElementById('stn-lbl');
        let c='#fff', n='', v='';
        if(r==='gnd'){c='var(--gnd)';n='SOLO';v=f.freqs.gnd;} if(r==='twr'){c='var(--twr)';n='TORRE';v=f.freqs.twr;}
        if(r==='app'){c='var(--app)';n='CTRL';v=f.freqs.app;} if(r==='acc'){c='var(--acc)';n='CENTRO';v=f.freqs.acc;}
        d.style.color=c; d.innerText=v; l.innerText=n;
        if(snd && audioCtx) playSquelch();
    }

    function updateSug() {
        if(!state.hasATIS && state.step===0) document.getElementById('sug-txt').innerText = "(Toque em METAR REAL acima)";
        else document.getElementById('sug-txt').innerText = state.step<script.length ? script[state.step].pilot() : "Voo Finalizado.";
    }
    function copySug() { document.getElementById('inp').value = document.getElementById('sug-txt').innerText; }
    function addLog(t, type) {
        const d = document.createElement('div'); d.className=`msg ${type}`; d.innerText=t;
        const l = document.getElementById('log'); l.appendChild(d); l.scrollTop = l.scrollHeight;
    }
    function saveState() { localStorage.setItem('atc_f', JSON.stringify(f)); localStorage.setItem('atc_s', JSON.stringify(state)); }

    /* AUDIO */
    let audioCtx, noise;
    function initAudio() { window.AudioContext=window.AudioContext||window.webkitAudioContext; if(!audioCtx)audioCtx=new AudioContext(); }
    function playSquelch() {
        if(!audioCtx) initAudio(); if(audioCtx.state==='suspended') audioCtx.resume();
        const s=audioCtx.createBufferSource(); 
        if(!noise){ noise=audioCtx.createBuffer(1,audioCtx.sampleRate,audioCtx.sampleRate); const d=noise.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*0.2-0.1; }
        s.buffer=noise; const g=audioCtx.createGain(); g.gain.value=0.2;
        g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.2);
        s.connect(g); g.connect(audioCtx.destination); s.start();
    }
    const map={'0':'Zero','1':'Uno','2':'Dois','3':'Três','4':'Quatro','5':'Cinco','6':'Meia','7':'Sete','8':'Oito','9':'Niner','.':'Decimal'};
    function toPhonetic(t){ return t.replace(/([A-Z]{2}-[A-Z]{3})|(\d{3}\.\d{2})|(\b\d{1,4}\b)|(\d{2}[LRC])/g, m=>m.toUpperCase().split('').map(c=>map[c]||c).join(' ')); }
    function speak(t,r) {
        playSquelch(); const u=new SpeechSynthesisUtterance(toPhonetic(t)); u.lang='pt-BR';
        if(r==='twr'){u.rate=1.3;u.pitch=1.1;} if(r==='acc'){u.rate=1.1;u.pitch=0.7;} if(r==='atis'){u.rate=1.1;u.pitch=0.9;}
        const v=window.speechSynthesis.getVoices().find(x=>x.lang.includes('pt-BR')); if(v)u.voice=v;
        u.onend=playSquelch; window.speechSynthesis.speak(u);
    }
    window.speechSynthesis.getVoices();
</script>
</body>
</html>
